<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>I reduced my cloud bill 9% this month by favoring my most active Windows Phone app users (Live Tiles, Leaderboards, Toasts) - Jeff Wilcox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="I reduced my cloud bill 9% this month by favoring my most active Windows Phone app users (Live Tiles, Leaderboards, Toasts)">
    <meta name="author" content="Jeff Wilcox">
    

    <link href="http://feeds.feedburner.com/jeffwilcox" rel="alternate" title="Jeff Wilcox" type="application/atom+xml" />
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
    <link href="/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/css/jmw.css" rel="stylesheet"/>
    <script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/toc.js"></script>
    <script src="/js/jmw.js"></script>
    <link type="text/css" rel="stylesheet" href="//az414997.vo.msecnd.net/waz/syntax/styles/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="//az414997.vo.msecnd.net/waz/syntax/styles/shThemeDefault.css"/>
  </head>
<body data-spy="scroll" data-target=".wiki-sidebar">
    <div class="navbar navbar-inverse" role="navigation"><!-- formerly navbar-fixed-top -->
        <div class="navbar-inner">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">Jeff Wilcox</a>
                </div>
                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about/">About</a></li>
                    <li><a href="/posts/">Posts</a></li>
                    <li><a href="https://github.com/jeffwilcox">//github.com/jeffwilcox</a></li>
                    <li><a href="https://twitter.com/jeffwilcox">@jeffwilcox</a></li>
                    <li><a href="http://linkedin.com/in/jeffreywilcox">LinkedIn</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>



<div class="container">

  <div class="container">
    <div class="row">
      <div class="col-md-8">

        <div id="post">
          <h2 class="post-title"><!--<a href="/2012/05/favoring-active-users-for-tiles-and-processing/">-->I reduced my cloud bill 9% this month by favoring my most active Windows Phone app users (Live Tiles, Leaderboards, Toasts)<!--</a>--></h2>
          <div class="pull-right">
            <a href="https://twitter.com/share" class="twitter-share-button" data-via="jeffwilcox" data-count="none">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></p>
          </div>
          <p id="date" class="muted">
            
            
            <small>
              13 May 2012
            </small>
            
            <!--
            <ul class="categories nav nav-pills">
            <li>windows-phone</li><li>cloud</li><li>nodejs</li>
            </ul>
            -->
            
          </p>

          <div class="blogcontent">
            <p>I run a compute-intensive set of cloud operations for my users to let them see their points through a live tile generated in the cloud. I send toast notifications when your friends are nearby you. And these operations all build on top of mostly polling-based work I perform, as well as some real-time data I receive. As my push user base has grown into the 5- and 6- figures of users, I’ve found that my most appreciative users who love my app should be where I dedicate my cloud resources, as opposed to very rare users.</p>  <p>Ever since launching the cloud-backed services that power a lot of the neat value-add in Windows Phone for my application, 4th &amp; Mayor, I’ve learned a lot, and been trying some fun things along the way. Recently I’ve had a fun conversation with a few people about how I’m finding good ways to save money in my cloud computing bill, and though they may be “common sense” to some, they didn’t all occur to me when I created my initial implementation.</p>  <p><strong>I’m saving 9% on my bill over last month, although my user base has increased at a good clip, just by favoring my most active users.</strong></p>  <p>My app has four major cloud components powered by <a href="http://nodejs.org/">Node.js</a>:</p>  <ul>   <li>Hosting the <a href="http://www.4thandmayor.com">www.4thandmayor.com</a> web site</li>    <li>Hosting RESTful web services for the application to communicate with</li>    <li>Processing push notifications through real-time APIs as well as polling mechanisms (“worker” role)</li>    <li>Live tile image generation</li> </ul>  <p>The web server and services are all load balanced and in general experience pretty steady but low-CPU traffic. However, watching processing spikes and what’s going on, I realized that I was a) spending a ton of processing power updating live tiles of infrequent users of the app who may not even be looking and b) my push notifications mechanism is rather expensive and involved, and about 40% of the users of my app are relatively infrequent users.</p>  <p>Since I run a free app and all my costs are my own, I’m interested in cutting costs for those that must not get as much value from the app.</p>  <h3>History</h3>  <p>Over the months I’ve used a lot of different techniques, from exponential-backoff algorithms, server CPU loads, and even bugs, to see how it affects my costs. I saved a ton of money in April when a bug I introduced stopped most toasts from working! After fixing that bug, though, it was clear I needed to back off my expenses some by reducing load, compute, and traffic some – and so many of the users I was doing processing for effectively have no net change, no need for a new sweet live tile, etc.</p>  <h3>Tracking the ‘last seen’ date/time</h3>  <p>Every time that a Windows Phone application starts, for users who have opted in to receiving push notifications, you acquire the channel, and that takes the form of a URI. You typically want to send that URI to your service tiers to make sure that your app can continue to send notifications, especially if the channel URI changes.</p>  <p>I store a lot of fields for push notification users to help me provide cloud services at an implementation level, including:</p>  <ul>   <li>The date/time the connection happens (typically close to app start-up time)</li>    <li>The channel URI</li>    <li>The operating system version</li>    <li>The application version</li>    <li>The number of times the app has been run</li> </ul>  <p>One of the core reasons for these is to be able to remove processing and storing information about users who have abandoned my application. I generally define that as someone who hasn’t used the app in 60 days. Since my application doesn’t actually do much active processing and data storage (the “truth” is stored on foursquare, not my services), the worst case is that someone abandons the app for 60 days, runs it again, and I think they are a brand new user at a server implementation level.</p>  <p>Nothing fancy here, just make sure that you track the 'last seen’ date and time information. I use Mongo DB for my data storage, and so I use an <em>upsert</em> to do this operation. If it’s a brand new user, I set the seen information. If they’ve been a user before, that’s fine, I just update the ‘seen’ information.</p>  <h3>Where is the work going?</h3>  <p>An analysis of the work I’m doing found some expensive things:</p>  <ul>   <li>My live tiles are half static, half dynamic</li>    </ul><ul>     <li>Static: the front of my app’s tile, with “unread” notification count, are static and hosted on a CDN – cheap</li>      <li>Dynamic: the back tile is a leaderboard with friend profile pics, “points” for the current week, etc. Very expensive – images to download, images to composite, points that are always changing – very little can be cached</li>   </ul>    <li>Latency and data transfer costs communicating between my services, the web, image servers, data tiers, foursquare’s APIs, etc.</li>    <li>Having a fixed “poll” period for users’ scheduled work doesn’t make sense</li>   <p>Meanwhile, cheap things: Sending a toast push notification to MPNS is dirt cheap. Sending a tile notification is just as cheap, but not generating the tile! Calculating basic information is quick.</p>  <h3>Defining tiers of service</h3>  <p>Watching users in terms of app use and ‘last seen’, I decided to offer these levels of “service” where I could scale back the application. Some of this is still in progress in terms of updates, but basically:</p>  <table border="0" cellspacing="0" cellpadding="2" width="680"><tbody>     <tr>       <td valign="top" width="134"><strong><em>Tier</em></strong></td>        <td valign="top" width="117"><strong><em>Last seen</em></strong></td>        <td valign="top" width="207"><strong><em>Push Notification Processing</em></strong></td>        <td valign="top" width="222"><strong><em>Live Tiles</em></strong></td>     </tr>      <tr>       <td valign="top" width="134">Active</td>        <td valign="top" width="117">Within 2 days</td>        <td valign="top" width="207">Very active. Real-time and 20-30 polls per hour.</td>        <td valign="top" width="222">Real-time with any check-in, plus when the leaderboard tile is stale.</td>     </tr>      <tr>       <td valign="top" width="134">Recent</td>        <td valign="top" width="117">3.5 days</td>        <td valign="top" width="207">Polls fall back to 10-20 per hour.</td>        <td valign="top" width="222">When the leaderboard tile is stale.</td>     </tr>      <tr>       <td valign="top" width="134">“The One-Weeker”</td>        <td valign="top" width="117">7 days</td>        <td valign="top" width="207">1 pph</td>        <td valign="top" width="222">One leaderboard per day max.</td>     </tr>      <tr>       <td valign="top" width="134">Older</td>        <td valign="top" width="117">13 days</td>        <td valign="top" width="207">No polling</td>        <td valign="top" width="222">One leaderboard per day.</td>     </tr>      <tr>       <td valign="top" width="134">Oldest</td>        <td valign="top" width="117">Remainder</td>        <td valign="top" width="207">No polling</td>        <td valign="top" width="222">Once every 3 days max.</td>     </tr>   </tbody></table>  <p>And I should say, I just made these tiers up. So far, so good.</p>  <h3>Tiers without memory</h3>  <p>To minimize computation of actually figuring out how active a user is, I don’t do any active processing at all: rather, the tier is determined when I process a piece of due work for a client, and that helps me to figure out when to schedule the next piece of work.</p>  <p>I suppose another idea would be to try and figure out who my true “active” users are, but I’ve found that the days-since-seen indicator is actually quite great, simple, and really reducing my server processing loads.</p>  <h3>Implementation details</h3>  <p>Not that fancy! Here is the simple code for figuring out which tier a user is in. Dirty JavaScript, really.</p>  <pre class="brush: js">this.getPollFrequency = function () {
  var r = thisTask.r;
        var prop = 'oldest';
  if (r.seen) {
      var now = new Date().getTime();
            var then = r.seen.getTime();
            var diff = now - then;
            diff /= 1000;
            diff /= 60;
            diff /= 60;
            diff /= 24;

            if (diff &lt; 2) {
              prop = 'active';
            } else if (diff &lt; 3.5) {
              prop = 'recent';
            } else if (diff &lt; 7) {
              prop = 'week';
            } else if (diff &lt; 13) {
              prop = 'older';
            }
        }            
        thisTask.storage.activityFrequency = prop;
        return context.configuration.poll[prop];
}</pre>

<p>I then use this tier designation to look up a configurable property that I have, which is how long to wait before scheduling the next piece of work for the client. The other code isn’t that exciting, but will be part of some other posts at some point, I am sure.</p>

<p>Let me know if you’re able to make use of this concept, or how you might use it in your apps!</p>

          </div>
        </div>

      </div>

      <div class="col-md-4 wiki-sidebaZr" style="margin-top:18px">
            
    <p style="position: relative; width: 100%; height:195px; min-height: 120px; background: url(/jeffwilcox.png) no-repeat"></p>
    

    
<p class="lead" style="font-size:20px">
  Jeff Wilcox is a Software Engineer at Microsoft in the
  Open Source Programs Office (OSPO), helping Microsoft engineers
  use, contribute to and release open source at scale.
  
</p>
<!--
<p>
  Jeff is an alumnus of the University of Michigan, Ann Arbor, with
  a degree in Computer Science.
</p>
-->
    <p><a href="https://twitter.com/jeffwilcox" class="twitter-follow-button" data-show-count="true" data-size="medium">Follow @jeffwilcox</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></p>

    
       <div style="margin-top: 24px">
           <!-- small -->
               
                   
                   
                    
            
                   
                   
                    
            
                   
                   
                    
            
           <!-- /small -->
       </div>
    

    <div id="toc" class="wiki-sidebar" style="margin-top: 24px">
    </div>
    <script type="text/javascript">
    $(document).ready(function() {
        $('#toc').toc({
            listType: 'ul',
            noBackToTopLinks: true,
            showEffect: 'none',
            extraListGoo: ' class="nav wiki-sidenav"',
            extraListGoo2: ' class="nav"',
            showSpeed: 0,
            title: '<h4>Blog Post Explorer</h4>',
            headers: '.blogcontent h1, .blogcontent h2',
            firstItemHtml: '<li><a href="#top">Start</a></li>',
        });
        $('body').scrollspy('refresh');
    });
    </script>

      </div>

    </div><!-- row -->
  </div><!-- container 1 -->

  <div id="related">
    <h4>Other posts</h4>
    <ul class="posts">
      
        <li><span>25 Nov 2019</span> &raquo; <a href="/2019/11/evcondo/">My $6,000 Tesla Wall Connector: the story of bringing Electric Vehicle charging to a high-rise condo tower in Seattle</a></li>
      
        <li><span>25 Jun 2019</span> &raquo; <a href="/2019/06/scaling-25k/">Scaling from 2,000 to 25,000 engineers on GitHub at Microsoft</a></li>
      
        <li><span>10 Apr 2018</span> &raquo; <a href="/2018/04/seattle-network/">My home network: Ubiquiti UniFi gear, fiber gigabit Internet, CAT6 and CAT3 wiring</a></li>
      
        <li><span>28 Feb 2017</span> &raquo; <a href="/2017/02/azure-private-npm/">Deploying Node.js apps in Azure App Service using private npm feeds from Visual Studio Team Services</a></li>
      
    </ul>
  </div>

  
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jeffwilcox';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div><!-- container 2 -->

<div class="container">  
<hr />

<footer class="wiki-footer">
  <p class="pull-right"><a href="#top">Back to top</a></p>
  <div class="links">
    <a href="/">jeffwilcox.blog</a> |
    <a href="https://twitter.com/jeffwilcox">@jeffwilcox</a> |
    <a href="https://github.com/jeffwilcox/">github.com/jeffwilcox</a> |
    <a href="http://linkedin.com/in/jeffreywilcox">linkedin profile</a> |
    <a href="http://www.google.com/recaptcha/mailhide/d?k=01Tv_GmcqyJ7mtRaeIIZEB4w==&c=PqTaC_u8CDIyO7wQDBRbQC1w7tGtyj-TDjnJupt4zLw=">email</a> |
    <a href="http://feeds.feedburner.com/jeffwilcox">rss</a>
  </div>
  <p><small>&copy; Jeff Wilcox<br />
  <span class="muted">Disclaimer: The content on this site represents my own personal opinions and thoughts at the time of posting, and does not reflect those of my employer in any way.</span></small></p>
</footer>

</div><!-- /container -->
<script src="//az414997.vo.msecnd.net/waz/syntax/scripts/shCore.js" type="text/javascript"></script>
<script src="//az414997.vo.msecnd.net/waz/syntax/scripts/shAutoloader.js" type="text/javascript"></script>
<script type="text/javascript">
function stxpath()
{
  var args = arguments, result = [];
  for(var i = 0; i < args.length; i++) {
      result.push(args[i].replace('@', '//az414997.vo.msecnd.net/waz/syntax/scripts/'));
  }
  return result;
};
SyntaxHighlighter.autoloader.apply(null, stxpath(
  'bash shell             @shBrushBash.js',
  'c# c-sharp csharp      @shBrushCSharp.js',
  'js jscript javascript  @shBrushJScript.js',
  'text plain             @shBrushPlain.js',
  'xml xhtml xslt html    @shBrushXml.js'
));
SyntaxHighlighter.defaults['gutter'] = false;
SyntaxHighlighter.defaults['tab-size'] = 2;
SyntaxHighlighter.defaults['class-name'] = 'code';
SyntaxHighlighter.all(); //'code', false, true: tag, showGutter, showControls
</script>
<!-- Google Analytics -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-2695771-1");
pageTracker._trackPageview();
</script>
<!-- Google Analytics end -->
  </body>
</html>