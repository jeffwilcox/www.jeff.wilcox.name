<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Property change notifications for multithreaded Silverlight applications - Jeff Wilcox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Property change notifications for multithreaded Silverlight applications">
    <meta name="author" content="Jeff Wilcox">
    

    <link href="http://feeds.feedburner.com/jeffwilcox" rel="alternate" title="Jeff Wilcox" type="application/atom+xml" />
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
    <link href="/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/css/jmw.css" rel="stylesheet"/>
    <script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/toc.js"></script>
    <script src="/js/jmw.js"></script>
    <link type="text/css" rel="stylesheet" href="//az414997.vo.msecnd.net/waz/syntax/styles/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="//az414997.vo.msecnd.net/waz/syntax/styles/shThemeDefault.css"/>
  </head>
<body data-spy="scroll" data-target=".wiki-sidebar">
    <div class="navbar navbar-inverse" role="navigation"><!-- formerly navbar-fixed-top -->
        <div class="navbar-inner">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">Jeff Wilcox</a>
                </div>
                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about/">About</a></li>
                    <li><a href="/posts/">Posts</a></li>
                    <li><a href="https://github.com/jeffwilcox">//github.com/jeffwilcox</a></li>
                    <li><a href="https://twitter.com/jeffwilcox">@jeffwilcox</a></li>
                    <li><a href="http://linkedin.com/in/jeffreywilcox">LinkedIn</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>



<div class="container">

  <div class="container">
    <div class="row">
      <div class="col-md-8">

        <div id="post">
          <h2 class="post-title"><!--<a href="/2010/04/propertychangedbase-crossthread/">-->Property change notifications for multithreaded Silverlight applications<!--</a>--></h2>
          <div class="pull-right">
            <a href="https://twitter.com/share" class="twitter-share-button" data-via="jeffwilcox" data-count="none">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></p>
          </div>
          <p id="date" class="muted">
            
            
            <small>
               2 April 2010
            </small>
            
            <!--
            <ul class="categories nav nav-pills">
            
            </ul>
            -->
            
          </p>

          <div class="blogcontent">
            <p>As I’ve been developing more complex Silverlight business applications, I’ve been increasingly relying on <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.backgroundworker(VS.95).aspx">BackgroundWorker</a> to offload complex calculations and operations to the background thread.</p>  <p>Something I didn’t have to worry about in the typical user interface thread-only implementation of my app was which thread change notifications fire on.</p>  <p>Here’s a typical scenario:</p>  <ol>   <li>You have a CLR property on a data/model object in your app. In a background thread, the property is updated.</li>    <li>As all data and model objects should be, the type implements <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.inotifypropertychanged(VS.95).aspx">INotifyPropertyChanged</a> (the data binding system relies on this to know when to update bindings).</li>    <li>The property changed event is fired, and listeners react to the change, including the data binding system.</li>    <li>The data binding system throws an invalid cross thread exception, since all UI operations, including handing off the binding changes, need to happen on the UI thread (but it’s happening on a background thread)</li> </ol>  <p><a href="http://az414997.vo.msecnd.net/wordpress/2010/04/BackgroundThreadWithoutDispatcher.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="BackgroundThreadWithoutDispatcher" border="0" alt="BackgroundThreadWithoutDispatcher" src="http://az414997.vo.msecnd.net/wordpress/2010/04/BackgroundThreadWithoutDispatcher_thumb.png" width="685" height="160" /></a> </p>  <p>So what you really need to do is funnel those change notifications back to always happen on the user interface thread – that’s what makes the most sense given the data binding requirement.</p>  <p>By using a dispatcher, which can accept a BeginInvoke for that other thread, it will all just work and binding will move along happily:</p>  <p><a href="http://az414997.vo.msecnd.net/wordpress/2010/04/BackgroundThreadWithDispatcher.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="BackgroundThreadWithDispatcher" border="0" alt="BackgroundThreadWithDispatcher" src="http://az414997.vo.msecnd.net/wordpress/2010/04/BackgroundThreadWithDispatcher_thumb.png" width="685" height="160" /></a> </p>  <p>This scenario is ripe for a few helper classes that I’m open to receiving feedback on. Hope you agree with my approach of using a ‘smart dispatcher’.</p>  <h2>One Dispatcher to rule them all</h2>  <p>The only thing you need to fire an Action on the primary UI thread is a reference to a <a href="http://msdn.microsoft.com/en-us/library/system.windows.threading.dispatcher(VS.95).aspx">Dispatcher</a> instance. Unfortunately this isn’t something you can request from a background thread – you need to have the instance already stored away in most cases.</p>  <p>As a result, I’ve a static helper class and in it, I try and make sure that there is an instance stored before any of my data binding or model code is used.</p>  <p>Though I could have used <a href="http://msdn.microsoft.com/en-us/library/system.threading.synchronizationcontext.aspx">SynchronizationContext</a> instead, Dispatcher is a little easier to use, and better suited to WPF and Silverlight apps.</p>  <p>In my App.xaml.cs, I add a line that calls Initialize on my class. This is to make sure that there is <em>always</em> an available dispatcher for other threads to get access to:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:887EC618-8FBE-49a5-A908-2339AF2EC720:80de451c-9a3a-4b80-aa15-24fd2bf7890d" class="wlWriterEditableSmartContent"><pre class="brush: c-sharp">public App()
{
    this.Startup += this.Application_Startup;
    this.Exit += this.Application_Exit;
    this.UnhandledException += this.Application_UnhandledException;

    SmartDispatcher.Initialize(Deployment.Current.Dispatcher);

    InitializeComponent();
}</pre></div>

<p>If you didn’t want to have to add this code to initialization, my implementation of a dispatcher helper class falls back to trying to grab the dispatcher from the root visual – but this won’t work in all scenarios, so I prefer the above. One more thing to remember however.</p>

<h2>Being smart about using the dispatcher</h2>

<p>It’s easy enough to replace all event firings for property changes to go through the dispatcher. However, this will reduce performance some; instead of the call being made immediately, it’s made at a later time.</p>

<p>There is a hidden method called <a href="http://msdn.microsoft.com/en-us/library/system.windows.threading.dispatcher.checkaccess(v=VS.95).aspx">CheckAccess</a> on Dispatcher that returns true if you are on the same thread that the Dispatcher was first created in. By checking with it before making a call, we can make a better perf choice:</p>

<ul>
  <li>If CheckAccess is true and we’re on the UI thread, just go ahead and directly invoke the Action. </li>

  <li>Else, BeginInvoke with the Dispatcher that will take care of getting it done on the UI thread later. </li>
</ul>

<p>I’ve also done some optimization to try and ensure that the design-time experience at least stays consistent. In general you shouldn’t have background operations ever occurring in a design-time scenario.</p>

<p>The static helper class I’ve created is called <strong>SmartDispatcher</strong> and simplifies all of this logic.</p>

<p>So here’s my smart dispatcher implementation:</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:887EC618-8FBE-49a5-A908-2339AF2EC720:5f822523-5e30-4745-9db5-23a523f087b5" class="wlWriterEditableSmartContent"><pre class="brush: c-sharp">// (c) Copyright Microsoft Corporation.
// This source is subject to the Microsoft Public License (Ms-PL).
// Please see http://go.microsoft.com/fwlink/?LinkID=131993 for details.
// All other rights reserved.

using System.ComponentModel;

namespace System.Windows.Threading
{
    /// &lt;summary&gt;
    /// A smart dispatcher system for routing actions to the user interface
    /// thread.
    /// &lt;/summary&gt;
    public static class SmartDispatcher
    {
        /// &lt;summary&gt;
        /// A single Dispatcher instance to marshall actions to the user
        /// interface thread.
        /// &lt;/summary&gt;
        private static Dispatcher _instance;

        /// &lt;summary&gt;
        /// Backing field for a value indicating whether this is a design-time
        /// environment.
        /// &lt;/summary&gt;
        private static bool? _designer;
        
        /// &lt;summary&gt;
        /// Requires an instance and attempts to find a Dispatcher if one has
        /// not yet been set.
        /// &lt;/summary&gt;
        private static void RequireInstance()
        {
            if (_designer == null)
            {
                _designer = DesignerProperties.IsInDesignTool;
            }

            // Design-time is more of a no-op, won't be able to resolve the
            // dispatcher if it isn't already set in these situations.
            if (_designer == true)
            {
                return;
            }

            // Attempt to use the RootVisual of the plugin to retrieve a
            // dispatcher instance. This call will only succeed if the current
            // thread is the UI thread.
            try
            {
                _instance = Application.Current.RootVisual.Dispatcher;
            }
            catch (Exception e)
            {
                throw new InvalidOperationException("The first time SmartDispatcher is used must be from a user interface thread. Consider having the application call Initialize, with or without an instance.", e);
            }

            if (_instance == null)
            {
                throw new InvalidOperationException("Unable to find a suitable Dispatcher instance.");
            }
        }

        /// &lt;summary&gt;
        /// Initializes the SmartDispatcher system, attempting to use the
        /// RootVisual of the plugin to retrieve a Dispatcher instance.
        /// &lt;/summary&gt;
        public static void Initialize()
        {
            if (_instance == null)
            {
                RequireInstance();
            }
        }

        /// &lt;summary&gt;
        /// Initializes the SmartDispatcher system with the dispatcher
        /// instance.
        /// &lt;/summary&gt;
        /// &lt;param name="dispatcher"&gt;The dispatcher instance.&lt;/param&gt;
        public static void Initialize(Dispatcher dispatcher)
        {
            if (dispatcher == null)
            {
                throw new ArgumentNullException("dispatcher");
            }

            _instance = dispatcher;

            if (_designer == null)
            {
                _designer = DesignerProperties.IsInDesignTool;
            }
        }

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static bool CheckAccess()
        {
            if (_instance == null)
            {
                RequireInstance();
            }

            return _instance.CheckAccess();
        }

        /// &lt;summary&gt;
        /// Executes the specified delegate asynchronously on the user interface
        /// thread. If the current thread is the user interface thread, the
        /// dispatcher if not used and the operation happens immediately.
        /// &lt;/summary&gt;
        /// &lt;param name="a"&gt;A delegate to a method that takes no arguments and 
        /// does not return a value, which is either pushed onto the Dispatcher 
        /// event queue or immediately run, depending on the current thread.&lt;/param&gt;
        public static void BeginInvoke(Action a)
        {
            if (_instance == null)
            {
                RequireInstance();
            }

            // If the current thread is the user interface thread, skip the
            // dispatcher and directly invoke the Action.
            if (_instance.CheckAccess() || _designer == true)
            {
                a();
            }
            else
            {
                _instance.BeginInvoke(a);
            }
        }
    }
}</pre></div>

<h2>A property change base class</h2>

<p>Next up, instead of having to manually wire up the INotifyPropertyChanged interface in all my data classes, I prefer to derive from a common base class, PropertyChangedBase, that has logic in it to use my smart dispatcher.</p>

<p>This base class:</p>

<ul>
  <li>Has a protected NotifyPropertyChanged method that does all the real work</li>

  <li>Statically stores created event arguments to improve performance over time (only one PropertyChangedEventArgs instance is required per property name in the application’s lifetime)</li>

  <li>Uses SmartDispatcher to use a dispatcher only if not running on the user interface thread, otherwise directly invokes the property change handler.</li>
</ul>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:887EC618-8FBE-49a5-A908-2339AF2EC720:081eec95-108d-4637-bc82-a9dc32c0de06" class="wlWriterEditableSmartContent"><pre class="brush: c-sharp">// (c) Copyright Microsoft Corporation.
// This source is subject to the Microsoft Public License (Ms-PL).
// Please see http://go.microsoft.com/fwlink/?LinkID=131993 for details.
// All other rights reserved.

using System;
using System.Collections.Generic;
using System.Windows.Threading;

namespace System.ComponentModel
{
    /// &lt;summary&gt;
    /// A base class for data objects that implement the property changed 
    /// interface, offering data binding and change notifications.
    /// &lt;/summary&gt;
    public class PropertyChangedBase : INotifyPropertyChanged
    {
        /// &lt;summary&gt;
        /// A static set of argument instances, one per property name.
        /// &lt;/summary&gt;
        private static Dictionary&lt;string, PropertyChangedEventArgs&gt; _argumentInstances = new Dictionary&lt;string, PropertyChangedEventArgs&gt;();

        /// &lt;summary&gt;
        /// The property changed event.
        /// &lt;/summary&gt;
        public event PropertyChangedEventHandler PropertyChanged;

        /// &lt;summary&gt;
        /// Notify any listeners that the property value has changed.
        /// &lt;/summary&gt;
        /// &lt;param name="propertyName"&gt;The property name.&lt;/param&gt;
        protected void NotifyPropertyChanged(string propertyName)
        {
            PropertyChangedEventHandler handler = PropertyChanged;
            if (handler != null)
            {
                PropertyChangedEventArgs args;
                if (!_argumentInstances.TryGetValue(propertyName, out args))
                {
                    args = new PropertyChangedEventArgs(propertyName);
                    _argumentInstances[propertyName] = args;
                }

                // Fire the change event. The smart dispatcher will directly
                // invoke the handler if this change happened on the UI thread,
                // otherwise it is sent to the proper dispatcher.
                SmartDispatcher.BeginInvoke(delegate
                {
                    handler(this, args); 
                });
            }
        }
    }
}</pre></div>

<h2>Putting it all together</h2>

<p>To use this in your own application, you take your model/data classes and derive from PropertyChangedBase. Then, in CLR setters, always call NotifyPropertyChanged:</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:887EC618-8FBE-49a5-A908-2339AF2EC720:dc14a951-f0ec-424e-a0a3-da3b76cbeada" class="wlWriterEditableSmartContent"><pre class="brush: c-sharp">public class SampleData : PropertyChangedBase
{
    private string _someText;
    public string SomeText
    {
        get { return _someText; }
        set
        {
            _someText = value;
            NotifyPropertyChanged("SomeText");
        }
    }
}</pre></div>

<h2>Grab the code</h2>

<p>I’ve decided to place these classes inside their appropriate system namespaces: System.Windows.Threading for the smart dispatcher, and System.ComponentModel for the PropertyChangedBase. Hope that isn’t too offensive.</p>

<p>Here are the files for download as well:</p>

<ul>
  <li><a href="http://az414997.vo.msecnd.net/wordpress/2010/04/PropertyChangedBase.cs_.txt">PropertyChangedBase.cs</a></li>

  <li><a href="http://az414997.vo.msecnd.net/wordpress/2010/04/SmartDispatcher.cs_.txt">SmartDispatcher.cs</a></li>
</ul>

<p>Hope this helps. Let me know what you think.</p>

<p><em>Updated 8/6/2014: Thanks to Mark Bishop at Microsoft for suggesting a fix; null/empty property names are accepted <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.propertychangedeventargs.propertyname(v=vs.110).aspx">per msdn</a>.</em></p>
          </div>
        </div>

      </div>

      <div class="col-md-4 wiki-sidebaZr" style="margin-top:18px">
            
    <p style="position: relative; width: 100%; height:195px; min-height: 120px; background: url(/jeffwilcox.png) no-repeat"></p>
    

    
<p class="lead" style="font-size:20px">
  Jeff Wilcox is a Software Engineer at Microsoft in the
  Open Source Programs Office (OSPO), helping Microsoft engineers
  use, contribute to and release open source at scale.
  
</p>
<!--
<p>
  Jeff is an alumnus of the University of Michigan, Ann Arbor, with
  a degree in Computer Science.
</p>
-->
    <p><a href="https://twitter.com/jeffwilcox" class="twitter-follow-button" data-show-count="true" data-size="medium">Follow @jeffwilcox</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></p>

    
       <div style="margin-top: 24px">
           <!-- small -->
               
           <!-- /small -->
       </div>
    

    <div id="toc" class="wiki-sidebar" style="margin-top: 24px">
    </div>
    <script type="text/javascript">
    $(document).ready(function() {
        $('#toc').toc({
            listType: 'ul',
            noBackToTopLinks: true,
            showEffect: 'none',
            extraListGoo: ' class="nav wiki-sidenav"',
            extraListGoo2: ' class="nav"',
            showSpeed: 0,
            title: '<h4>Blog Post Explorer</h4>',
            headers: '.blogcontent h1, .blogcontent h2',
            firstItemHtml: '<li><a href="#top">Start</a></li>',
        });
        $('body').scrollspy('refresh');
    });
    </script>

      </div>

    </div><!-- row -->
  </div><!-- container 1 -->

  <div id="related">
    <h4>Other posts</h4>
    <ul class="posts">
      
        <li><span>25 Nov 2019</span> &raquo; <a href="/2019/11/evcondo/">My $6,000 Tesla Wall Connector: the story of bringing Electric Vehicle charging to a high-rise condo tower in Seattle</a></li>
      
        <li><span>25 Jun 2019</span> &raquo; <a href="/2019/06/scaling-25k/">Scaling from 2,000 to 25,000 engineers on GitHub at Microsoft</a></li>
      
        <li><span>10 Apr 2018</span> &raquo; <a href="/2018/04/seattle-network/">My home network: Ubiquiti UniFi gear, fiber gigabit Internet, CAT6 and CAT3 wiring</a></li>
      
        <li><span>28 Feb 2017</span> &raquo; <a href="/2017/02/azure-private-npm/">Deploying Node.js apps in Azure App Service using private npm feeds from Visual Studio Team Services</a></li>
      
    </ul>
  </div>

  
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jeffwilcox';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div><!-- container 2 -->

<div class="container">  
<hr />

<footer class="wiki-footer">
  <p class="pull-right"><a href="#top">Back to top</a></p>
  <div class="links">
    <a href="/">jeffwilcox.blog</a> |
    <a href="https://twitter.com/jeffwilcox">@jeffwilcox</a> |
    <a href="https://github.com/jeffwilcox/">github.com/jeffwilcox</a> |
    <a href="http://linkedin.com/in/jeffreywilcox">linkedin profile</a> |
    <a href="http://www.google.com/recaptcha/mailhide/d?k=01Tv_GmcqyJ7mtRaeIIZEB4w==&c=PqTaC_u8CDIyO7wQDBRbQC1w7tGtyj-TDjnJupt4zLw=">email</a> |
    <a href="http://feeds.feedburner.com/jeffwilcox">rss</a>
  </div>
  <p><small>&copy; Jeff Wilcox<br />
  <span class="muted">Disclaimer: The content on this site represents my own personal opinions and thoughts at the time of posting, and does not reflect those of my employer in any way.</span></small></p>
</footer>

</div><!-- /container -->
<script src="//az414997.vo.msecnd.net/waz/syntax/scripts/shCore.js" type="text/javascript"></script>
<script src="//az414997.vo.msecnd.net/waz/syntax/scripts/shAutoloader.js" type="text/javascript"></script>
<script type="text/javascript">
function stxpath()
{
  var args = arguments, result = [];
  for(var i = 0; i < args.length; i++) {
      result.push(args[i].replace('@', '//az414997.vo.msecnd.net/waz/syntax/scripts/'));
  }
  return result;
};
SyntaxHighlighter.autoloader.apply(null, stxpath(
  'bash shell             @shBrushBash.js',
  'c# c-sharp csharp      @shBrushCSharp.js',
  'js jscript javascript  @shBrushJScript.js',
  'text plain             @shBrushPlain.js',
  'xml xhtml xslt html    @shBrushXml.js'
));
SyntaxHighlighter.defaults['gutter'] = false;
SyntaxHighlighter.defaults['tab-size'] = 2;
SyntaxHighlighter.defaults['class-name'] = 'code';
SyntaxHighlighter.all(); //'code', false, true: tag, showGutter, showControls
</script>
<!-- Google Analytics -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-2695771-1");
pageTracker._trackPageview();
</script>
<!-- Google Analytics end -->
  </body>
</html>