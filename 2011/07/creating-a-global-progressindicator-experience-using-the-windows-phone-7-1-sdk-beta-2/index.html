<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Creating a global ProgressIndicator experience using the Windows Phone 7.1 SDK Beta 2 - Jeff Wilcox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Creating a global ProgressIndicator experience using the Windows Phone 7.1 SDK Beta 2">
    <meta name="author" content="Jeff Wilcox">
    

    <link href="http://feeds.feedburner.com/jeffwilcox" rel="alternate" title="Jeff Wilcox" type="application/atom+xml" />
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
    <link href="/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/css/jmw.css" rel="stylesheet"/>
    <script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/toc.js"></script>
    <script src="/js/jmw.js"></script>
    <link type="text/css" rel="stylesheet" href="//az414997.vo.msecnd.net/waz/syntax/styles/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="//az414997.vo.msecnd.net/waz/syntax/styles/shThemeDefault.css"/>
  </head>
<body data-spy="scroll" data-target=".wiki-sidebar">
    <div class="navbar navbar-inverse" role="navigation"><!-- formerly navbar-fixed-top -->
        <div class="navbar-inner">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">Jeff Wilcox</a>
                </div>
                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about/">About</a></li>
                    <li><a href="/posts/">Posts</a></li>
                    <li><a href="https://github.com/jeffwilcox">//github.com/jeffwilcox</a></li>
                    <li><a href="https://twitter.com/jeffwilcox">@jeffwilcox</a></li>
                    <li><a href="http://linkedin.com/in/jeffreywilcox">LinkedIn</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>



<div class="container">

  <div class="container">
    <div class="row">
      <div class="col-md-8">

        <div id="post">
          <h2 class="post-title"><!--<a href="/2011/07/creating-a-global-progressindicator-experience-using-the-windows-phone-7-1-sdk-beta-2/">-->Creating a global ProgressIndicator experience using the Windows Phone 7.1 SDK Beta 2<!--</a>--></h2>
          <div class="pull-right">
            <a href="https://twitter.com/share" class="twitter-share-button" data-via="jeffwilcox" data-count="none">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></p>
          </div>
          <p id="date" class="muted">
            
            
            <small>
               7 July 2011
            </small>
            
            <!--
            <ul class="categories nav nav-pills">
            
            </ul>
            -->
            
          </p>

          <div class="blogcontent">
            <p>One of the nice new features in the 7.1 release of Windows Phone for developers is ProgressIndicator support right within the app platform, removing the need in many situations for the Silverlight-based PerformanceProgressBar control that I created some time ago.</p>  <p>(The PerformanceProgressBar was a decent performance improvement over the stock ProgressBar in the first release of the OS, but offloading the control to the OS improves performance even more. As many people pointed out, the rich visualization wasn’t free.)</p>  <p>So my initial thought was that I could use the new ProgressIndicator control and have a single instance to use throughout my app. Not so fast! Unfortunately (in my mind) the ProgressIndicator property is a SystemTray property and it’s set on every single page instance.</p>  <p>In my applications, I prefer to wire all key events (data downloads, long-running tasks, etc.) to a single, centralized ‘global loading’ control, removing the need to have more than a single progress bar instance in the app.</p>  <p>So in this post quickly we’ll:</p>  <ul>   <li>See how to hook up the GlobalLoading when your app starts up</li>    <li>Note that the navigation framework’s events are used to auto-hookup the same shared progress indicator instance to every page</li>    <li>See how to use the IsLoading setter to turn on and off the loading experience</li> </ul>  <h3>My old &amp; new strategies</h3>  <p>In my 7.0 apps, I would re-template the root phone application frame and have the single indeterminate progress bar in there, so it’s always available.</p>  <p>In 7.1, my goal is to be able to re-purpose my existing global loading system. I want to create a single instance of the new ProgressIndicator type, and then automatically have it set to every single page’s appropriate system tray property automatically. This will eliminate any manual hook-up required, so it will just always be present and work.</p>  <h3>Initializing the global loading system at startup</h3>  <p>In order to always have the progress indicator visible, I need to make sure it’s always set when a page navigation happens, sharing that single instance. Let’s use the Navigated event of the PhoneApplicationFrame that is created in App.xaml.cs.</p>  <ul>   <li>Open up your 7.1 app’s App.xaml.cs </li>    <li>Expand the “Phone application initialization” region in the editor </li>    <li>At line ~120 (in a new project), where the RootFrame is set, add the initialize call. </li> </ul>  <pre class="brush: c-sharp">GlobalLoading.Instance.Initialize(RootFrame);</pre>

<h3>Hooking up to the Navigated event</h3>

<p>Now, you’ll see that inside the global loading system implementation below, I’m using the Navigated event to set the ProgressIndicator property with every complete navigation:</p>

<pre class="brush: c-sharp">private void OnRootFrameNavigated(object sender, NavigationEventArgs e)
{
    // Use in Mango to share a single progress indicator instance.
    var ee = e.Content;
    var pp = ee as PhoneApplicationPage;
    if (pp != null)
    {
        pp.SetValue(SystemTray.ProgressIndicatorProperty, _mangoIndicator);
    }
}</pre>

<p>Nothing for you to do other than include the GlobalLoading.cs file in your project.</p>

<h3>Using the global loading system</h3>

<p>Now, in my app, I have two ways of providing data to this global loader, one of which is pretty automatic:</p>

<ul>
  <li>AgFx: I hook up to the DataManager’s property change event, looking for changes in its own central IsLoading property</li>

  <li>You can set GlobalLoading.Instance.IsLoading to <em>true</em> or <em>false</em></li>
</ul>

<p>Note that setting IsLoading to true <em>increments</em> an internal counter, and setting to false decrements; the idea is that you match operations to results: if you start a web browser navigation and set IsLoaded to True, make sure that when the navigation is complete or canceled, you set it to False.</p>

<p>However, if multiple requests are happening at once, the loading indication will not stop until all requests have completed.</p>

<p>Now, one of the downfalls of using simple integer arithmetic here is that you could potentially forget to increment or decrement, leaving the indicator always going, and likely keeping your app from making it through the marketplace ingestion requirements.</p>

<p>A better solution might be to request and use “tokens” or some sort of instance that could either timeout or be used to debug your app’s logic; it would also allow you to use the new progress indicator’s text property to provide information about loading operations (“Currently loading 2 things…”, “Refreshing your places list”), which is more interesting.</p>

<p>The cool <a href="http://hiddenpineapple.com/rowi/">Rowi</a> app does this.</p>

<h3>Data binding or not</h3>

<p>In my 7.0 implementation, I actually directly data bind a central PerformanceProgressBar’s IsLoading property to the GlobalLoading.Instance.ActualIsLoading property; in 7.1, I decided for simplicity to instead just directly set the progress indicator’s values, but I maybe could have data bound to the indicator. Let me know if you try that and have any issues!</p>

<p>Here’s the source to GlobalLoading.cs. I’ve commented out the AgFx parts in case you’re not using that system.</p>

<h3>GlobalLoading.cs</h3>

<pre class="brush: c-sharp">using System.ComponentModel;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
// using AgFx;
using Microsoft.Phone.Controls;
using Microsoft.Phone.Shell;

namespace JeffWilcox.FourthAndMayor
{
    public class GlobalLoading : INotifyPropertyChanged
    {
        private ProgressIndicator _mangoIndicator;

        private GlobalLoading()
        {
        }

        public void Initialize(PhoneApplicationFrame frame)
        {
            // If using AgFx:
            // DataManager.Current.PropertyChanged += OnDataManagerPropertyChanged;

            _mangoIndicator = new ProgressIndicator();

            frame.Navigated += OnRootFrameNavigated;
        }

        private void OnRootFrameNavigated(object sender, NavigationEventArgs e)
        {
            // Use in Mango to share a single progress indicator instance.
            var ee = e.Content;
            var pp = ee as PhoneApplicationPage;
            if (pp != null)
            {
                pp.SetValue(SystemTray.ProgressIndicatorProperty, _mangoIndicator);
            }
        }

        private void OnDataManagerPropertyChanged(object sender, PropertyChangedEventArgs e)
        {
            if (&quot;IsLoading&quot; == e.PropertyName)
            {
                // if AgFx: IsDataManagerLoading = DataManager.Current.IsLoading;
                NotifyValueChanged();
            }
        }

        private static GlobalLoading _in;
        public static GlobalLoading Instance
        {
            get
            {
                if (_in == null)
                {
                    _in = new GlobalLoading();
                }

                return _in;
            }
        }

        public bool IsDataManagerLoading { get; set; }

        public bool ActualIsLoading
        {
            get
            {
                return IsLoading || IsDataManagerLoading;
            }
        }

        private int _loadingCount;

        public bool IsLoading
        {
            get
            {
                return _loadingCount &gt; 0;
            }
            set
            {
                bool loading = IsLoading;
                if (value)
                {
                    ++_loadingCount;
                }
                else
                {
                    --_loadingCount;
                }

                NotifyValueChanged();
            }
        }

        private void NotifyValueChanged()
        {
            if (_mangoIndicator != null)
            {
                _mangoIndicator.IsIndeterminate = _loadingCount &gt; 0 || IsDataManagerLoading;

                // for now, just make sure it's always visible.
                if (_mangoIndicator.IsVisible == false)
                {
                    _mangoIndicator.IsVisible = true;
                }
            }
        }

        public event PropertyChangedEventHandler PropertyChanged;

        protected virtual void RaisePropertyChanged(string propertyName)
        {
            PropertyChangedEventHandler handler = PropertyChanged;
            if (handler != null)
            {
                handler(this, new PropertyChangedEventArgs(propertyName));
            }
        }
    }
}</pre>

<p>Hope this helps!</p>

          </div>
        </div>

      </div>

      <div class="col-md-4 wiki-sidebaZr" style="margin-top:18px">
            
    <p style="position: relative; width: 100%; height:195px; min-height: 120px; background: url(/jeffwilcox.png) no-repeat"></p>
    

    
<p class="lead" style="font-size:20px">
  Jeff Wilcox is a Software Engineer at Microsoft in the
  Open Source Programs Office (OSPO), helping Microsoft engineers
  use, contribute to and release open source at scale.
  
</p>
<!--
<p>
  Jeff is an alumnus of the University of Michigan, Ann Arbor, with
  a degree in Computer Science.
</p>
-->
    <p><a href="https://twitter.com/jeffwilcox" class="twitter-follow-button" data-show-count="true" data-size="medium">Follow @jeffwilcox</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></p>

    
       <div style="margin-top: 24px">
           <!-- small -->
               
           <!-- /small -->
       </div>
    

    <div id="toc" class="wiki-sidebar" style="margin-top: 24px">
    </div>
    <script type="text/javascript">
    $(document).ready(function() {
        $('#toc').toc({
            listType: 'ul',
            noBackToTopLinks: true,
            showEffect: 'none',
            extraListGoo: ' class="nav wiki-sidenav"',
            extraListGoo2: ' class="nav"',
            showSpeed: 0,
            title: '<h4>Blog Post Explorer</h4>',
            headers: '.blogcontent h1, .blogcontent h2',
            firstItemHtml: '<li><a href="#top">Start</a></li>',
        });
        $('body').scrollspy('refresh');
    });
    </script>

      </div>

    </div><!-- row -->
  </div><!-- container 1 -->

  <div id="related">
    <h4>Other posts</h4>
    <ul class="posts">
      
        <li><span>25 Nov 2019</span> &raquo; <a href="/2019/11/evcondo/">My $6,000 Tesla Wall Connector: the story of bringing Electric Vehicle charging to a high-rise condo tower in Seattle</a></li>
      
        <li><span>25 Jun 2019</span> &raquo; <a href="/2019/06/scaling-25k/">Scaling from 2,000 to 25,000 engineers on GitHub at Microsoft</a></li>
      
        <li><span>10 Apr 2018</span> &raquo; <a href="/2018/04/seattle-network/">My home network: Ubiquiti UniFi gear, fiber gigabit Internet, CAT6 and CAT3 wiring</a></li>
      
        <li><span>28 Feb 2017</span> &raquo; <a href="/2017/02/azure-private-npm/">Deploying Node.js apps in Azure App Service using private npm feeds from Visual Studio Team Services</a></li>
      
    </ul>
  </div>

  
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jeffwilcox';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div><!-- container 2 -->

<div class="container">  
<hr />

<footer class="wiki-footer">
  <p class="pull-right"><a href="#top">Back to top</a></p>
  <div class="links">
    <a href="/">jeffwilcox.blog</a> |
    <a href="https://twitter.com/jeffwilcox">@jeffwilcox</a> |
    <a href="https://github.com/jeffwilcox/">github.com/jeffwilcox</a> |
    <a href="http://linkedin.com/in/jeffreywilcox">linkedin profile</a> |
    <a href="http://www.google.com/recaptcha/mailhide/d?k=01Tv_GmcqyJ7mtRaeIIZEB4w==&c=PqTaC_u8CDIyO7wQDBRbQC1w7tGtyj-TDjnJupt4zLw=">email</a> |
    <a href="http://feeds.feedburner.com/jeffwilcox">rss</a>
  </div>
  <p><small>&copy; Jeff Wilcox<br />
  <span class="muted">Disclaimer: The content on this site represents my own personal opinions and thoughts at the time of posting, and does not reflect those of my employer in any way.</span></small></p>
</footer>

</div><!-- /container -->
<script src="//az414997.vo.msecnd.net/waz/syntax/scripts/shCore.js" type="text/javascript"></script>
<script src="//az414997.vo.msecnd.net/waz/syntax/scripts/shAutoloader.js" type="text/javascript"></script>
<script type="text/javascript">
function stxpath()
{
  var args = arguments, result = [];
  for(var i = 0; i < args.length; i++) {
      result.push(args[i].replace('@', '//az414997.vo.msecnd.net/waz/syntax/scripts/'));
  }
  return result;
};
SyntaxHighlighter.autoloader.apply(null, stxpath(
  'bash shell             @shBrushBash.js',
  'c# c-sharp csharp      @shBrushCSharp.js',
  'js jscript javascript  @shBrushJScript.js',
  'text plain             @shBrushPlain.js',
  'xml xhtml xslt html    @shBrushXml.js'
));
SyntaxHighlighter.defaults['gutter'] = false;
SyntaxHighlighter.defaults['tab-size'] = 2;
SyntaxHighlighter.defaults['class-name'] = 'code';
SyntaxHighlighter.all(); //'code', false, true: tag, showGutter, showControls
</script>
<!-- Google Analytics -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-2695771-1");
pageTracker._trackPageview();
</script>
<!-- Google Analytics end -->
  </body>
</html>